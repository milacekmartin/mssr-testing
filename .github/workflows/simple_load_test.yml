name: Simple Load Test (Locust)

on:
  workflow_dispatch:
    inputs:
      users:
        description: "Number of concurrent users"
        required: true
        default: "10"

      rampup:
        description: "User spawn rate (users per second)"
        required: true
        default: "5"

      duration:
        description: "Test duration (e.g. 1m, 5m, 30s)"
        required: true
        default: "1m"

      base_url:
        description: "Base application URL"
        required: false
        default: "https://test-eprihlasky.iedu.sk"

      idp_url:
        description: "TIAM Identity Provider URL"
        required: false
        default: "https://tiamidsk.iedu.sk"

      username:
        description: "Login username (optional)"
        required: false

      password:
        description: "Login password (optional)"
        required: false

permissions:
  contents: read
  pages: write
  id-token: write

jobs:
  simple-loadtest:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install locust requests beautifulsoup4

      - name: Set runtime environment
        run: |
          echo "BASE_URL=${{ inputs.base_url }}" >> $GITHUB_ENV
          echo "IDP_URL=${{ inputs.idp_url }}" >> $GITHUB_ENV
          echo "LOGIN_USERNAME=${{ inputs.username || secrets.LOGIN_USERNAME }}" >> $GITHUB_ENV
          echo "LOGIN_PASSWORD=${{ inputs.password || secrets.LOGIN_PASSWORD }}" >> $GITHUB_ENV

      - name: Run Simple Locust Test
        run: |
          set +e
          mkdir -p pages/simple-loadtest

          python3 -m locust \
            -f tests/locust/full_flow_locust_all.py \
            --headless \
            -u ${{ inputs.users }} \
            -r ${{ inputs.rampup }} \
            -t ${{ inputs.duration }} \
            --html pages/simple-loadtest/report.html \
            --csv pages/simple-loadtest/results \
            --only-summary \
            --host ${{ inputs.base_url }}

      - name: Ensure landing page
        if: ${{ always() }}
        run: |
            mkdir -p pages
            if [ ! -f pages/index.html ]; then
                printf '%s\n' \
                    '<!DOCTYPE html>' \
                    '<html>' \
                    '<head>' \
                    '<meta charset="utf-8">' \
                    '<title>Performance Reports</title>' \
                    '</head>' \
                    '<body>' \
                    '<h1>Performance Test Reports</h1>' \
                    '<ul>' \
                    '<li><a href="loadtest/">Behaviour Load Tests</a></li>' \
                    '<li><a href="simple-loadtest/">Simple Load Tests</a></li>' \
                    '</ul>' \
                    '</body>' \
                    '</html>' \
                    > pages/index.html
                fi

      - name: Upload GitHub Pages Artifact
        if: ${{ always() }}
        uses: actions/upload-pages-artifact@v3
        with:
          path: pages

  deploy-pages:
    needs: simple-loadtest
    runs-on: ubuntu-latest
    environment:
      name: github-pages
    permissions:
      pages: write
      id-token: write

    steps:
      - uses: actions/deploy-pages@v4
