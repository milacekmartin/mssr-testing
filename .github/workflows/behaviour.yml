name: Behaviour Load Test (Locust)

on:
  workflow_dispatch:
    inputs:
      profile:
        description: "Load profile from tests/locust/load_profiles"
        required: true
        default: "light_mixed"
        type: choice
        options:
          - baseline
          - capacity
          - light_baseline
          - light_mixed
          - light_peak
          - light_spike
          - peak
          - regression
          - soak
          - spike
          - stress
          - warmup

      base_url:
        description: "Base application URL"
        required: false
        default: "https://test-eprihlasky.iedu.sk"

      idp_url:
        description: "TIAM Identity Provider URL"
        required: false
        default: "https://tiamidsk.iedu.sk"

      username:
        description: "Login username (optional)"
        required: false

      password:
        description: "Login password (optional)"
        required: false

permissions:
  contents: read

jobs:
  behaviour:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Runtime environment
        run: |
          echo "BASE_URL=${{ inputs.base_url }}" >> $GITHUB_ENV
          echo "IDP_URL=${{ inputs.idp_url }}" >> $GITHUB_ENV
          echo "LOGIN_USERNAME=${{ inputs.username || secrets.LOGIN_USERNAME }}" >> $GITHUB_ENV
          echo "LOGIN_PASSWORD=${{ inputs.password || secrets.LOGIN_PASSWORD }}" >> $GITHUB_ENV
          echo "LOAD_PROFILE_NAME=${{ inputs.profile }}" >> $GITHUB_ENV

      - name: Run Locust (Behaviour)
        run: |
          set +e
          mkdir -p tests/locust/logs

          python3 -m locust \
            -f tests/locust/full_flow_spawn.py \
            --headless \
            --csv tests/locust/temp/results \
            --html tests/locust/temp/report.html \
            --only-summary \
            2>&1 | tee tests/locust/logs/locust.log

      - name: Generate behaviour report
        if: always()
        run: |
          python3 tests/locust/utils/generate_pdf_report.py
          python3 tests/locust/utils/generate_loadtest_dashboard.py

      - name: Upload behaviour artifact
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: behaviour-pages
          path: pages/loadtest
