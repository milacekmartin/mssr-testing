name: Behaviour Load Test (Locust)

on:
  workflow_dispatch:
    inputs:
      profile:
        description: "Load profile from tests/locust/load_profiles"
        required: true
        default: "light_mixed"

      base_url:
        description: "Base application URL"
        required: false
        default: "https://test-eprihlasky.iedu.sk"

      idp_url:
        description: "TIAM Identity Provider URL"
        required: false
        default: "https://tiamidsk.iedu.sk"

      username:
        description: "Login username (optional)"
        required: false

      password:
        description: "Login password (optional)"
        required: false

permissions:
  contents: read
  pages: write
  id-token: write

jobs:
  loadtest:
    name: Run Behaviour Load Test
    runs-on: ubuntu-latest

    steps:
      # --------------------------------------------------
      # CHECKOUT
      # --------------------------------------------------
      - name: Checkout repository
        uses: actions/checkout@v4

      # --------------------------------------------------
      # PYTHON
      # --------------------------------------------------
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      # --------------------------------------------------
      # DEPENDENCIES
      # --------------------------------------------------
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      # --------------------------------------------------
      # RUNTIME ENV
      # --------------------------------------------------
      - name: Set runtime environment
        run: |
          echo "BASE_URL=${{ inputs.base_url }}" >> $GITHUB_ENV
          echo "IDP_URL=${{ inputs.idp_url }}" >> $GITHUB_ENV
          echo "LOGIN_USERNAME=${{ inputs.username || secrets.LOGIN_USERNAME }}" >> $GITHUB_ENV
          echo "LOGIN_PASSWORD=${{ inputs.password || secrets.LOGIN_PASSWORD }}" >> $GITHUB_ENV
          echo "LOAD_PROFILE_NAME=${{ inputs.profile }}" >> $GITHUB_ENV

      # --------------------------------------------------
      # LOCUST EXECUTION
      # --------------------------------------------------
      - name: Run Locust (Behaviour)
        run: |
          set +e

          echo "â–¶ Starting Locust (profile: ${LOAD_PROFILE_NAME})"

          python3 -m locust \
            -f tests/locust/full_flow_spawn.py \
            --headless \
            --csv tests/locust/temp/results \
            --html tests/locust/temp/report.html \
            --only-summary \
            2>&1 | tee tests/locust/logs/locust.log

          echo "LOCUST_EXIT_CODE=$?" >> $GITHUB_ENV

      # --------------------------------------------------
      # REPORTING (ALWAYS)
      # --------------------------------------------------
      - name: Generate PDF report and HTML dashboard
        if: ${{ always() }}
        run: |
          python3 tests/locust/utils/generate_pdf_report.py
          python3 tests/locust/utils/generate_loadtest_dashboard.py

      # --------------------------------------------------
      # GITHUB PAGES ARTIFACT
      # --------------------------------------------------
      - name: Upload GitHub Pages Artifact
        if: ${{ always() }}
        uses: actions/upload-pages-artifact@v3
        with:
          path: pages

  deploy-pages:
    name: Deploy to GitHub Pages
    needs: loadtest
    runs-on: ubuntu-latest
    environment:
      name: github-pages
    permissions:
      pages: write
      id-token: write

    steps:
      - name: Deploy Pages
        uses: actions/deploy-pages@v4
