name: Behaviour Load Test (Locust)

on:
  workflow_dispatch:
    inputs:
      profile:
        description: "Load profile from tests/locust/load_profiles"
        required: true
        default: "light_mixed"
        type: string

      base_url:
        description: "Base application URL (ePrihlasky frontend / API)"
        required: false
        default: "https://test-eprihlasky.iedu.sk"
        type: string

      idp_url:
        description: "Base TIAM Identity Provider URL"
        required: false
        default: "https://tiamidsk.iedu.sk"
        type: string

      username:
        description: "Login username (overrides GitHub secret if provided)"
        required: false
        type: string

      password:
        description: "Login password (overrides GitHub secret if provided)"
        required: false
        type: string

permissions:
  contents: write   # REQUIRED for push to gh-pages

jobs:
  behaviour:
    name: Run Behaviour Load Test
    uses: ./.github/workflows/base_runtime.yml
    secrets: inherit

    with:
      base_url: ${{ inputs.base_url }}
      idp_url:  ${{ inputs.idp_url }}
      username: ${{ inputs.username }}
      password: ${{ inputs.password }}

      extra_env: |
        export LOAD_PROFILE_NAME=${{ inputs.profile }}

      python_command: |
        set +e

        echo "â–¶ Starting Locust (profile: ${LOAD_PROFILE_NAME})"

        python3 -m locust \
          -f tests/locust/full_flow_spawn.py \
          --headless \
          --csv tests/locust/temp/results \
          --html tests/locust/temp/report.html \
          --only-summary

        LOCUST_EXIT_CODE=$?
        echo "Locust finished with exit code: ${LOCUST_EXIT_CODE}"

        echo "â–¶ Generating PDF report"
        python3 tests/locust/utils/generate_pdf_report.py

        echo "â–¶ Generating HTML dashboard + ZIP artifacts"
        python3 tests/locust/utils/generate_loadtest_dashboard.py

        exit ${LOCUST_EXIT_CODE}

  publish:
    name: Publish Reports to GitHub Pages
    runs-on: ubuntu-latest
    needs: behaviour
    if: always()

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Download loadtest artifact
        uses: actions/download-artifact@v4
        with:
          name: loadtest-pages
          path: pages

      - name: Switch to gh-pages branch
        run: |
          git fetch origin gh-pages
          git checkout gh-pages

      - name: Replace loadtest reports
        run: |
          rm -rf loadtest
          mv pages/loadtest loadtest

      - name: Commit and push
        run: |
          git config user.name "github-actions"
          git config user.email "github-actions@github.com"

          git add loadtest
          git commit -m "ðŸ“Š Load test report (${GITHUB_RUN_NUMBER})" || echo "Nothing to commit"
          git push origin gh-pages
