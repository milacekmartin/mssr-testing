name: Locust Load Test (ZŠ scénár)

on:
  workflow_dispatch:
    inputs:
      users:
        description: "Number of concurrent users"
        required: true
        default: "10"

      rampup:
        description: "User spawn rate (users per second)"
        required: true
        default: "5"

      duration:
        description: "Test duration (e.g. 1m, 5m, 30s)"
        required: true
        default: "1m"

      host:
        description: "Target host (base URL)"
        required: true
        default: "https://test-eprihlasky.iedu.sk"

      username:
        description: "Login username (optional – overrides GitHub Secret)"
        required: false

      password:
        description: "Login password (optional – overrides GitHub Secret)"
        required: false

  push:
    branches:
      - main
      - master

permissions:
  contents: read
  pages: write
  id-token: write

jobs:
  loadtest:
    runs-on: ubuntu-latest

    steps:
      # ==========================================================
      # CHECKOUT REPO
      # ==========================================================
      - name: Checkout repository
        uses: actions/checkout@v4

      # ==========================================================
      # SETUP PYTHON
      # ==========================================================
      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: "3.11"

      # ==========================================================
      # INSTALL DEPENDENCIES
      # ==========================================================
      - name: Install dependencies
        run: |
          python3 -m pip install --upgrade pip
          pip install locust requests beautifulsoup4

      # ==========================================================
      # RESOLVE INPUTS
      # ==========================================================
      - name: Resolve inputs
        id: vars
        run: |
          USERS="${{ github.event.inputs.users || '10' }}"
          RAMPUP="${{ github.event.inputs.rampup || '5' }}"
          DURATION="${{ github.event.inputs.duration || '1m' }}"
          HOST="${{ github.event.inputs.host || 'https://test-eprihlasky.iedu.sk' }}"

          echo "users=$USERS" >> $GITHUB_OUTPUT
          echo "rampup=$RAMPUP" >> $GITHUB_OUTPUT
          echo "duration=$DURATION" >> $GITHUB_OUTPUT
          echo "host=$HOST" >> $GITHUB_OUTPUT

          echo "▶ USERS=$USERS"
          echo "▶ RAMPUP=$RAMPUP"
          echo "▶ DURATION=$DURATION"
          echo "▶ HOST=$HOST"

      # ==========================================================
      # RESOLVE CREDENTIALS (INPUTS > SECRETS)
      # ==========================================================
      - name: Resolve credentials
        id: creds
        run: |
          USERNAME="${{ github.event.inputs.username }}"
          PASSWORD="${{ github.event.inputs.password }}"

          if [ -z "$USERNAME" ]; then
            USERNAME="${{ secrets.LOGIN_USERNAME }}"
            SOURCE="secrets"
          else
            SOURCE="manual-input"
          fi

          if [ -z "$PASSWORD" ]; then
            PASSWORD="${{ secrets.LOGIN_PASSWORD }}"
          fi

          if [ -z "$USERNAME" ] || [ -z "$PASSWORD" ]; then
            echo "❌ Credentials missing (inputs or secrets)"
            exit 1
          fi

          echo "source=$SOURCE" >> $GITHUB_OUTPUT
          echo "LOGIN_USERNAME=$USERNAME" >> $GITHUB_ENV
          echo "LOGIN_PASSWORD=$PASSWORD" >> $GITHUB_ENV

          echo "✔ Credentials resolved from: $SOURCE"

      # ==========================================================
      # RUN LOCUST LOAD TEST
      # ==========================================================
      - name: Run Locust ZŠ scénár
        continue-on-error: true
        env:
          LOGIN_USERNAME: ${{ env.LOGIN_USERNAME }}
          LOGIN_PASSWORD: ${{ env.LOGIN_PASSWORD }}
        run: |
          python3 -m locust \
            -f tests/prihlaska/full_flow_locust.py \
            --headless \
            -u ${{ steps.vars.outputs.users }} \
            -r ${{ steps.vars.outputs.rampup }} \
            -t ${{ steps.vars.outputs.duration }} \
            --csv results \
            --html report.html \
            --only-summary \
            --host ${{ steps.vars.outputs.host }}

      # ==========================================================
      # PREPARE HTML + CSV FOR GITHUB PAGES
      # ==========================================================
      - name: Prepare HTML for GitHub Pages
        if: ${{ always() }}
        run: |
          mkdir -p pages/loadtest

          if [ -f report.html ]; then
            mv report.html pages/loadtest/report.html
          fi

          if [ -f results_stats.csv ]; then
            mv results_stats.csv pages/loadtest/
          fi
          if [ -f results_requests.csv ]; then
            mv results_requests.csv pages/loadtest/
          fi
          if [ -f results_failures.csv ]; then
            mv results_failures.csv pages/loadtest/
          fi

          if [ -f utils/generate_html_report.py ]; then
            python3 utils/generate_html_report.py index
          fi

          echo "--- Pages folder content ---"
          ls -R pages

      # ==========================================================
      # UPLOAD PAGES ARTIFACT
      # ==========================================================
      - name: Upload GitHub Pages Artifact
        if: ${{ always() }}
        uses: actions/upload-pages-artifact@v3
        with:
          path: pages

  # ==========================================================
  # DEPLOY TO GITHUB PAGES
  # ==========================================================
  deploy-pages:
    needs: loadtest
    runs-on: ubuntu-latest
    permissions:
      pages: write
      id-token: write
    environment:
      name: github-pages
    steps:
      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4
