name: Locust Load Test (Z≈† sc√©n√°r)

on:
  workflow_dispatch:
  push:
    branches:
      - main
      - master

permissions:
  contents: read
  pages: write
  id-token: write

jobs:
  loadtest:
    runs-on: ubuntu-latest

    steps:
      # --- CHECKOUT REPO ---
      - name: Checkout repository
        uses: actions/checkout@v4

      # --- INSTALL PYTHON ---
      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'

      # --- INSTALL DEPENDENCIES ---
      - name: Install dependencies
        run: |
          python3 -m pip install --upgrade pip
          pip install locust requests beautifulsoup4

      # ==========================================================
      # RUN LOCUST LOADTEST (BEHAVIOR TEST)
      # ==========================================================
      - name: Run Locust Z≈† sc√©n√°r
        run: |
          python3 -m locust -f locustfile_zs.py \
            --headless \
            -u 10 \
            -r 10 \
            -t 1m \
            --csv results \
            --html report.html \
            --only-summary \
            --host https://test-eprihlasky.iedu.sk
        continue-on-error: true   # üî• aj pri FAIL pokraƒçuje workflow

      # ==========================================================
      # GENERATE HTML + CSV + INDEX
      # ==========================================================
      - name: Prepare HTML for GitHub Pages
        if: ${{ always() }}
        run: |
          mkdir -p pages/loadtest

          # Move html report
          if [ -f report.html ]; then mv report.html pages/loadtest/report.html; fi

          # Move CSV files if exist
          if [ -f results_stats.csv ]; then mv results_stats.csv pages/loadtest/; fi
          if [ -f results_requests.csv ]; then mv results_requests.csv pages/loadtest/; fi
          if [ -f results_failures.csv ]; then mv results_failures.csv pages/loadtest/; fi

          # generate index
          python3 utils/generate_html_report.py index

          echo "--- Pages folder content ---"
          ls -R pages

      # ==========================================================
      # UPLOAD STATIC SITE
      # ==========================================================
      - name: Upload GitHub Pages Artifact
        if: ${{ always() }}
        uses: actions/upload-pages-artifact@v3
        with:
          path: pages

  # ==========================================================
  # DEPLOYMENT JOB
  # ==========================================================
  deploy-pages:
    needs: loadtest
    runs-on: ubuntu-latest
    permissions:
      pages: write
      id-token: write
    environment:
      name: github-pages
    steps:
      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4
